---
title: "Wykad 5"
subtitle: "Kod 藕r贸dowy i kod maszynowy"
---

{{< part "Budowa programu" >}}

{{< slide-animate "Funkcja <code>main</code>" >}}
	{{< code lang="cpp" lines="1-2" >}}
		int main() {
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< slide-animate "Inicjalizacja" >}}
	{{< code lang="cpp" lines="1-3,6" >}}
		void gpioInit() {
			// Inicjalizacja GPIO
		}

		int main() {
			gpioInit();
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< slide-animate "Nieskoczona ptla" >}}
	{{< code lang="cpp" lines="7-8" >}}
		void gpioInit() {
			// Inicjalizacja GPIO
		}

		int main() {
			gpioInit();
			while (true) {
			}
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< slide-animate "Funkcja g贸wna" >}}
	{{< code lang="cpp" lines="5-7,13" >}}
		void gpioInit() {
			// Inicjalizacja GPIO
		}

		void ledBlink() {
			// Mruganie diod
		}

		int main()
		{
			gpioInit();
			while (true) {
				ledBlink();
			}
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< slide-animate "Obsuga przerwa" >}}
	{{< code lang="cpp" lines="9-11" >}}
		void gpioInit() {
			// Inicjalizacja GPIO
		}

		void ledBlink() {
			// Mruganie diod
		}

		ISR(TIMER0_OVF_vect) {
			// Obsuga timera
		}

		int main()
		{
			gpioInit();
			while (true) {
				ledBlink();
			}
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< slide-animate "Komunikacja przerwa z ptl g贸wn" >}}
	{{< code lang="cpp" lines="5,9-12,16" >}}
		void gpioInit() {
			// Inicjalizacja GPIO
		}

		volatile bool timerFlag;

		void ledBlink() {
			// Mruganie diod
			if (timerFlag) {
				// Reakcja na upyw czasu
				timerFlag = false;
			}
		}

		ISR(TIMER0_OVF_vect) {
			timerFlag = true;
		}

		int main()
		{
			gpioInit();
			while (true) {
				ledBlink();
			}
		}
	{{< /code >}}
{{< /slide-animate >}}

{{< part "Proces kompilacji i linkowania" >}}
{{< img-slide compiling.webp />}}

{{< part "Pliki nag贸wkowe" >}}

{{< slide "Deklaracja i definicja funkcji" >}}
	{{<	fragment "foo.h (deklaracja z dokumentacj)" >}}
		{{< code lang="cpp" lines="1-6" >}}
			/** Robi co wa偶nego.
			 *  @param argument Liczba wejciowa.
			 *  @return Kod bdu. */
			int foo(int argument);
		{{< /code >}}
	{{< /fragment >}}
	{{<	fragment "foo.c (definicja)" >}}
		{{< code lang="cpp" lines="1,3,5" >}}
			#include "foo.h"

			int foo(int argument) {
				// Bardzo mdra funkcja
			}
		{{< /code >}}
	{{< /fragment >}}
	{{<	fragment "bar.c (wywoanie)" >}}
		{{< code lang="cpp" lines="1,4" >}}
			#include "foo.h"

			void bar() {
				int result = foo(42);
			}
		{{< /code >}}
	{{< /fragment >}}
{{< /slide >}}

{{< slide "Deklaracja i definicja zmiennej" >}}
	{{<	fragment "foo.h (deklaracja z dokumentacj)" >}}
		{{< code lang="cpp" lines="1" >}}
			int foo; ///< Licznik dziwnych zdarze.
		{{< /code >}}
	{{< /fragment >}}
	{{<	fragment "foo.c (definicja)" >}}
		{{< code lang="cpp" lines="1,3,5" >}}
			#include "foo.h"

			int foo = 42;
		{{< /code >}}
	{{< /fragment >}}
	{{<	fragment "bar.c (wywoanie)" >}}
		{{< code lang="cpp" lines="1,4" >}}
			#include "foo.h"

			void bar() {
				printf("%d\n", foo);
			}
		{{< /code >}}
	{{< /fragment >}}
{{< /slide >}}

{{< part "Kod maszynowy" >}}

{{< img-slide avr-gcc-1.webp >}}
	{{< note >}}<code>rcall</code> to trik w celu zarezerwowania jednym rozkazem dw贸ch bajt贸w na stosie.{{< /note >}}
	{{< note >}}<code>r28:r29</code> to rejestr <code>Y</code>.{{< /note >}}
	{{< note >}}<code>r18r27, r30, r31</code> nie musz by odkadane na stosie, bo kompilator zakada, 偶e (poza przerwaniami) bdzie ich u偶ywa tak, 偶e nie ma takiej potrzeby.{{< /note >}}
{{< /img-slide >}}
{{< img-slide avr-gcc-2.webp />}}
{{< img-slide avr-gcc-3.webp />}}
{{< img-slide avr-gcc-4.webp />}}
{{< img-slide avr-gcc-5.webp />}}

{{< part "Sekcje pamici" >}}
{{< img-slide c-code-gen.webp />}}

{{< part "Zarzdzanie pamici" >}}

{{< ul-slide "Dane statyczne" >}}
	{{< lf >}}stae, zmienne globalne i statyczne (<code>static</code>)
	{{< lf >}}deterministyczne
	{{< lf >}}praktycznie natychmiastowe
	{{< lf >}}bardzo bezpieczne (<em>safety-critical</em>) 
{{< /ul-slide >}}

{{< ul-slide "Stos" >}}
	{{< lf >}}deterministyczny
	{{< lf >}}szybki
	{{< lf >}}wspierany sprztowo
	{{< lf >}}mo偶liwo przepenienia np. przez rekurencj く
	{{< lf >}}zazwyczaj mae dane
	{{< lf >}}dane lokalne
	{{< lf >}}dane dostpne przez czas 偶ycia funkcji
{{< /ul-slide >}}

{{< ul-slide "Sterta" >}}
	{{< lf >}}niedeterministyczna
	{{< lf >}}realizacja programowa
	{{< lf >}}fragmentacja
	{{< lf >}}dane dostpne przez nieograniczony czas
	{{< lf >}}wycieki pamici
	{{< lf >}}obsuga przez wska藕niki
	{{< lf >}}C: <code>malloc()</code>, <code>free()</code>
	{{< lf >}}C++: <del><code>new</code></del>, <del><code>delete</code></del>,
		<code>unique_ptr&lt;T&gt;</code>, <code>shared_ptr&lt;T&gt;</code>
{{< /ul-slide >}}

{{< part "Wektor przerwa" >}}

{{< slide-animate "Listing" >}}
	{{< code lines="1-2|3,4,6|5" >}}
		00000000 <__vectors>:
		   0:	0c 94 46 00 	jmp	0x8c	; 0x8c <__ctors_end>
		   4:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   8:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   c:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__vector_3>
		  10:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
	{{< /code >}}
{{< /slide-animate >}}
{{< slide-animate "Listing" >}}
	{{< code lines="2,8-16" >}}
		00000000 <__vectors>:
		   0:	0c 94 46 00 	jmp	0x8c	; 0x8c <__ctors_end>
		   4:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   8:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   c:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__vector_3>
		  10:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>

		0000008c <__ctors_end>:
		  8c:	11 24       	eor	r1, r1
		  8e:	1f be       	out	0x3f, r1	; 63
		  90:	cf ef       	ldi	r28, 0xFF	; 255
		  92:	d0 e4       	ldi	r29, 0x40	; 64
		  94:	de bf       	out	0x3e, r29	; 62
		  96:	cd bf       	out	0x3d, r28	; 61
		  98:	0e 94 5c 00 	call	0xb8	; 0xb8 &lt;main&gt;
		  9c:	0c 94 65 00 	jmp	0xca	; 0xca <_exit>
	{{< /code >}}
{{< /slide-animate >}}
{{< slide-animate "Listing" >}}
	{{< code lines="3,4,6,8-9,1" >}}
		00000000 <__vectors>:
		   0:	0c 94 46 00 	jmp	0x8c	; 0x8c <__ctors_end>
		   4:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   8:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   c:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__vector_3>
		  10:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>

		000000a0 <__bad_interrupt>:
		  a0:	0c 94 00 00 	jmp	0	; 0x0 <__vectors>
	{{< /code >}}
{{< /slide-animate >}}
{{< slide-animate "Listing" >}}
	{{< code lines="5,8-18" >}}
		00000000 <__vectors>:
		   0:	0c 94 46 00 	jmp	0x8c	; 0x8c <__ctors_end>
		   4:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   8:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>
		   c:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__vector_3>
		  10:	0c 94 50 00 	jmp	0xa0	; 0xa0 <__bad_interrupt>

		000000a4 <__vector_3>:
		  a4:	1f 92       	push	r1
		  a6:	0f 92       	push	r0
		  a8:	0f b6       	in	r0, 0x3f	; 63
		  aa:	0f 92       	push	r0
		  ac:	11 24       	eor	r1, r1
		  ae:	0f 90       	pop	r0
		  b0:	0f be       	out	0x3f, r0	; 63
		  b2:	0f 90       	pop	r0
		  b4:	1f 90       	pop	r1
		  b6:	18 95       	reti
	{{< /code >}}
{{< /slide-animate >}}

{{< part "Wska藕niki na zmienne i funkcje" >}}

